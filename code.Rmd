```{r}
library(readxl)
library(dplyr)
library(caret)
library(xgboost)
library(ggplot2)
```


```{r}
file_path <- "/Users/mo/Desktop/Data Mining/Data-Mining-Project/Data/Latest Reported Events (4).xlsx"
diseaseInfo <- read_excel(file_path)
```

```{r}
head(diseaseInfo)
```


```{r}
diseaseInfo <- diseaseInfo %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>%
  mutate(across(where(is.character), ~replace_na(., "Unknown")))
```

```{r}
diseaseInfo$Region <- as.numeric(factor(diseaseInfo$Region))
diseaseInfo$disease <- as.numeric(factor(diseaseInfo$disease))
diseaseInfo$locality <- as.numeric(factor(diseaseInfo$locality))
diseaseInfo$country <- as.numeric(factor(diseaseInfo$country))
diseaseInfo$Species <- as.numeric(factor(diseaseInfo$Species))
diseaseInfo$`diagnosisSource` <- as.numeric(factor(diseaseInfo$`diagnosisSource`))
diseaseInfo$`Diagnosis Status` <- as.numeric(factor(diseaseInfo$`Diagnosis Status`))
diseaseInfo$`observation date` <- as.numeric(as.Date(diseaseInfo$`observation date`))
diseaseInfo$`report date` <- as.numeric(as.Date(diseaseInfo$`report date`))

```

```{r}
target <- "humansAffected"
features <- setdiff(names(diseaseInfo), target)
```

```{r}
diseaseInfo[features] <- lapply(diseaseInfo[features], as.numeric)
```


```{r}
set.seed(123)
trainIndex <- createDataPartition(diseaseInfo[[target]], p = 0.8, 
                                  list = FALSE, 
                                  times = 1)
dataTrain <- diseaseInfo[trainIndex, ]
dataTest <- diseaseInfo[-trainIndex, ]
```

```{r}
train_matrix <- xgb.DMatrix(data = as.matrix(dataTrain[, features]), label = dataTrain[[target]])
test_matrix <- xgb.DMatrix(data = as.matrix(dataTest[, features]), label = dataTest[[target]])

```

```{r}
params <- list(
  objective = "reg:squarederror",
  eval_metric = "rmse",
  max_depth = 6,
  eta = 0.3,
  nthread = 2
)
```

```{r}
xgb_model <- xgb.train(params = params, 
                       data = train_matrix, 
                       nrounds = 100, 
                       watchlist = list(train = train_matrix, eval = test_matrix), 
                       verbose = 1)
```

```{r}
preds <- predict(xgb_model, test_matrix)
```

```{r}
mse <- mean((dataTest[[target]] - preds)^2)
rmse <- sqrt(mse)
cat("Root Mean Squared Error: ", rmse, "\n")
```

```{r}
dataTest$preds <- preds
country_agg <- dataTest %>%
  group_by(country) %>%
  summarize(total_affected = sum(preds)) %>%
  arrange(desc(total_affected))
```

```{r}
ggplot(country_agg, aes(x = country, y = total_affected)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_minimal() +
  labs(title = "Total Affected People by Country",
       x = "Country",
       y = "Total Affected People") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
importance_matrix <- xgb.importance(feature_names = features, model = xgb_model)
xgb.plot.importance(importance_matrix)
```

